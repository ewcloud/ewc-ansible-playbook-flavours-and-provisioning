name: Deployment Test on ECMWF

on:
  workflow_dispatch:
    inputs:
      osExternalNetworkName:
        required: true
        default: 'external-internet'

      osPrivateNetworkName:
        required: true
        default: 'private-cci1-ewcloud-eumetsat-ewc-communityhub'

      osSecurityGroupName:
        required: true
        default: 'ssh'

      osKeypairName:
        required: true
        default: 'github-keypair'

      osFlavorName:
        required: true
        default: '8cpu-16gbmem-80gbdisk'

      osImageName:
        required: true
        default: 'Rocky-9.6-20251107141503'

      instanceNamePrefix:
        required: true
        default: 'github'

      pythonVersion:
        required: true
        default: '3.10.19'

      ansibleVersion:
        required: true
        default: '10.7.0'

      ansibleUser:
        required: true
        default: 'cloud-user'

      pathToMainFile:
        required: true
        default: 'playbooks/ssh-bastion-flavour/ssh-bastion-flavour.yml'

      pathToRequirementsFile:
        required: false

      inputSpecJson:
        required: false

permissions:
  contents: read
  actions: write

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test deployment
        id: test-deployment
        uses: ewcloud/ewc-gh-action-test-deploy-ansible-playbook@v2
        with:
          osAuthUrl: '${{ secrets.ECMWF_OS_AUTH_URL }}'
          osRegionName: '${{ secrets.ECMWF_OS_REGION_NAME }}'
          osApplicationCredentialId: '${{ secrets.ECMWF_OS_APPLICATION_CREDENTIAL_ID }}'
          osApplicationCredentialSecret: '${{ secrets.ECMWF_OS_APPLICATION_CREDENTIAL_SECRET }}'
          osExternalNetworkName: '${{ inputs.osExternalNetworkName }}'
          osPrivateNetworkName: '${{ inputs.osPrivateNetworkName }}'
          osSecurityGroupName: '${{ inputs.osSecurityGroupName }}'
          osKeypairName: '${{ inputs.osKeypairName }}'
          osFlavorName: '${{ inputs.osFlavorName }}'
          osImageName: '${{ inputs.osImageName }}'
          instanceNamePrefix: '${{ inputs.instanceNamePrefix }}'
          ansibleSshPrivateKey: '${{ secrets.ANSIBLE_SSH_PRIVATE_KEY }}'
          pythonVersion: '${{ inputs.pythonVersion }}'
          ansibleVersion: '${{ inputs.ansibleVersion }}'
          ansibleUser: '${{ inputs.ansibleUser }}'
          pathToMainFile: '${{ inputs.pathToMainFile }}'
          pathToRequirementsFile: '${{ inputs.pathToRequirementsFile }}'
          inputSpecJson: '${{ inputs.inputSpecJson }}'

      - name: Upload test deployment result
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: artifacts_${{ github.run_id }}
          path: ${{ steps.test-deployment.outputs.artifactPath }}
